ğŸ—ï¸ Architect

æˆ‘å·²æ·±å…¥ç ”è¯» `doc/åˆå¹¶.md` (å†å²è®°å½•æ ‘æ–¹æ¡ˆ) ä¸ `doc/plan.md` (æ··åˆ Agent æ¶æ„è§„åˆ’)ã€‚

**æ ¸å¿ƒæ•´åˆæ€è·¯ï¼š**
æˆ‘ä»¬å°† `doc/plan.md` ä¸­çš„ **Jacquard (ç¼–æ’å™¨)** ç¡®ç«‹ä¸ºç³»ç»Ÿçš„æ ¸å¿ƒè°ƒåº¦ä¸­æ¢ï¼Œè€Œå°† `doc/åˆå¹¶.md` ä¸­çš„ **"Turn-based Tree"** åŠå…¶æ•°æ®è®¿é—®å±‚å°è£…ä¸º **History Engine (å†å²å¼•æ“)**ï¼Œä½œä¸º Data Layer çš„å…³é”®å­ç³»ç»Ÿã€‚

è¿™ç§èåˆè§£å†³äº†åŸè®¡åˆ’ä¸­å…³äº"å†å²å¦‚ä½•ç®¡ç†"çš„æ¨¡ç³Šåœ°å¸¦ï¼š
1.  **Jacquard** ä¸å†ç›´æ¥æ“ä½œå­—ç¬¦ä¸²åˆ—è¡¨ï¼Œè€Œæ˜¯æŒæœ‰ **Session Pointer (æŒ‡é’ˆ)**ã€‚
2.  **PromptAST** ä¸­çš„ "History Slot" æ•°æ®æ¥æºï¼Œæ­£æ˜¯ **History Engine** æ ¹æ®æŒ‡é’ˆè®¡ç®—å‡ºçš„ **çº¿æ€§æŠ•å½± (Projection)**ã€‚
3.  **Post-Process Agent** æå–çš„çŠ¶æ€å˜æ›´ (State Delta)ï¼Œå°†ä½œä¸º **å¿«ç…§ (Snapshot)** å­˜å‚¨åœ¨å½“å‰çš„ **Context Node** ä¸Šï¼Œä»è€Œå®ç°å®Œç¾çš„æ—¶é—´æ—…è¡Œï¼ˆå›æº¯å†å²æ—¶ï¼ŒçŠ¶æ€åŒæ­¥å›æ»šï¼‰ã€‚

æˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆè¿™ä»½åä¸º `doc/system_architecture.md` çš„é«˜å±‚æ¶æ„è®¾è®¡æ–‡æ¡£ã€‚

<tool_code>
import os

file_content = """# PyTavern ç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£ (System Architecture Design Document)

**ç‰ˆæœ¬**: 1.0
**çŠ¶æ€**: Draft
**æœ€åæ›´æ–°**: 2025-12-19

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡ (Background & Objectives)

### 1.1 é¡¹ç›®èƒŒæ™¯
æœ¬é¡¹ç›®æ—¨åœ¨æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯å®šåˆ¶çš„ AI è§’è‰²æ‰®æ¼”ï¼ˆRPGï¼‰å®¢æˆ·ç«¯ã€‚ç°æœ‰è§£å†³æ–¹æ¡ˆï¼ˆå¦‚ SillyTavernï¼‰åœ¨å¤„ç†å¤æ‚é€»è¾‘æ—¶é¢ä¸´æ€§èƒ½ç“¶é¢ˆï¼ˆå‰ç«¯é‡é€»è¾‘ï¼‰å’Œä¸Šä¸‹æ–‡ç®¡ç†æ··ä¹±ï¼ˆå­—ç¬¦ä¸²æ‹¼æ¥éš¾ä»¥ç»´æŠ¤ï¼‰çš„é—®é¢˜ã€‚

### 1.2 æ ¸å¿ƒç›®æ ‡
1.  **æ¶æ„è§£è€¦**ï¼šå®ç° UIï¼ˆFlutterï¼‰ä¸é€»è¾‘ï¼ˆDart Orchestratorï¼‰çš„å½»åº•åˆ†ç¦»ã€‚
2.  **ç¡®å®šæ€§ç¼–æ’**ï¼šé€šè¿‡ä»£ç æ§åˆ¶æµç¨‹ï¼Œé€šè¿‡ LLM å¤„ç†è¯­ä¹‰ï¼Œæ‹’ç»â€œè®© LLM å†³å®šä¸€åˆ‡â€ã€‚
3.  **æ—¶ç©ºä¸€è‡´æ€§**ï¼šå¼•å…¥â€œå¤šé‡å®‡å®™æ ‘ï¼ˆTurn-based Treeï¼‰â€æ¨¡å‹ç®¡ç†å¯¹è¯å†å²ï¼Œæ”¯æŒæ— æŸçš„å›æº¯ã€åˆ†æ”¯ï¼ˆRerollï¼‰å’ŒçŠ¶æ€å¿«ç…§ã€‚
4.  **ç»“æ„åŒ– Prompt**ï¼šé‡‡ç”¨ PromptASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰æ›¿ä»£ä¼ ç»Ÿçš„å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå®ç°æ¨¡å—åŒ–çš„ä¸Šä¸‹æ–‡è£…é…ã€‚

---

## 2. æ€»ä½“æ¶æ„è§†å›¾ (System Context)

æœ¬ç³»ç»Ÿé‡‡ç”¨ **æ··åˆ Agent æ¶æ„ (Hybrid Agent Architecture)**ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯å°†åº”ç”¨åˆ’åˆ†ä¸ºä¸‰ä¸ªç‰©ç†éš”ç¦»ä½†é€»è¾‘ç´§å¯†çš„å±‚æ¬¡ï¼š**è¡¨ç°å±‚**ã€**ç¼–æ’å±‚** å’Œ **æ•°æ®/åŸºç¡€è®¾æ–½å±‚**ã€‚

```mermaid
graph TD
    %% æ ·å¼å®šä¹‰
    classDef ui fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef orch fill:#fff3e0,stroke:#e65100,stroke-width:2px;
    classDef data fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px;
    classDef ext fill:#f3e5f5,stroke:#4a148c,stroke-width:2px;

    User((ç”¨æˆ·))

    subgraph Presentation_Layer [è¡¨ç°å±‚ (Flutter)]
        UI_Chat[èŠå¤©ç•Œé¢]:::ui
        UI_Webview[Webview åŠ¨æ€ç»„ä»¶]:::ui
        UI_State[UI çŠ¶æ€ç®¡ç† (Riverpod)]:::ui
    end

    subgraph Orchestration_Layer [ç¼–æ’å±‚ (Dart)]
        Orchestrator[Orchestrator (æ€»çº¿/è°ƒåº¦å™¨)]:::orch
        Prompt_Engine[PromptAST è£…é…å¼•æ“]:::orch
        Session_Manager[ä¼šè¯æŒ‡é’ˆç®¡ç†]:::orch
    end

    subgraph Agent_Layer [Agent æœåŠ¡å±‚]
        Planner[Planner Agent (å†³ç­–)]:::ext
        Generator[Core LLM (ç”Ÿæˆ)]:::ext
        Persister[Post-Process Agent (åå¤„ç†)]:::ext
    end

    subgraph Data_Layer [æ•°æ®ä¸åŸºç¡€è®¾æ–½å±‚]
        History_Engine[å†å²å¼•æ“ (Tree Model)]:::data
        World_Engine[ä¸–ç•Œå¼•æ“ (Rules/Lore/State)]:::data
        Vector_DB[å‘é‡æ•°æ®åº“ (Memory)]:::data
        SQLite[(SQLite ç‰©ç†å­˜å‚¨)]:::data
    end

    %% å…³ç³»è¿æ¥
    User <--> UI_Chat
    UI_Chat <--> UI_State
    UI_State <--> Orchestrator
    UI_Webview <--> Orchestrator

    Orchestrator --> Session_Manager
    Orchestrator --> Prompt_Engine
    Orchestrator --> Planner
    Orchestrator --> Generator
    Orchestrator --> Persister

    Orchestrator <--> History_Engine
    Orchestrator <--> World_Engine
    
    History_Engine --> SQLite
    World_Engine --> SQLite
    World_Engine --> Vector_DB
```

---

## 3. æ ¸å¿ƒæ¨¡å—è¯¦ç»†è®¾è®¡ (Core Modules)

### 3.1 ç¼–æ’å±‚ (Orchestration Layer)
ç³»ç»Ÿçš„â€œå¤§è„‘â€ï¼Œè´Ÿè´£ç¡®å®šæ€§çš„æµç¨‹æ§åˆ¶ã€‚å®ƒä¸æ˜¯ AIï¼Œè€Œæ˜¯ AI çš„ç®¡ç†è€…ã€‚

*   **Orchestrator**: 
    *   **èŒè´£**: ç»´æŠ¤ Agentic Loopï¼ˆæ„ŸçŸ¥-å†³ç­–-è¡ŒåŠ¨å¾ªç¯ï¼‰ã€‚
    *   **è¾“å…¥**: ç”¨æˆ·æ„å›¾ã€UI äº‹ä»¶ã€‚
    *   **è¾“å‡º**: UI æ¸²æŸ“æŒ‡ä»¤ã€æ•°æ®å˜æ›´æ“ä½œã€‚
*   **Session Manager**:
    *   **èŒè´£**: æŒæœ‰ `Session Pointer` (å½“å‰æŒ‡å‘çš„ Node ID å’Œ Record ID)ã€‚
    *   **é€»è¾‘**: æ‰€æœ‰çš„â€œä¸Šä¸€è½®â€ã€â€œä¸‹ä¸€è½®â€æ“ä½œä»…ä¿®æ”¹æŒ‡é’ˆï¼Œä¸ä¿®æ”¹æ•°æ®ã€‚
*   **Prompt Engine (PromptAST)**:
    *   **èŒè´£**: å°†åˆ†æ•£çš„æ•°æ®ï¼ˆå†å²ã€ä¸–ç•Œä¹¦ã€çŠ¶æ€ï¼‰ç»„è£…æˆç»“æ„åŒ–çš„ Prompt è“å›¾ã€‚
    *   **ç»„ä»¶**: `BlueprintBuilder`, `TokenTrimmer`, `TemplateRenderer`.

### 3.2 æ•°æ®å±‚ï¼šå†å²å¼•æ“ (History Engine)
åŸºäº `doc/åˆå¹¶.md` çš„æ·±åº¦æ•´åˆè®¾è®¡ã€‚

*   **æ¨¡å‹**: **Turn-based Tree (åŸºäºè½®æ¬¡çš„æ ‘)**ã€‚
*   **æ ¸å¿ƒå®ä½“**:
    *   **Context Node (é”šç‚¹)**: ä»£è¡¨â€œç”¨æˆ·è¾“å…¥åã€AI å›å¤å‰â€çš„ä¸–ç•ŒçŠ¶æ€ã€‚å­˜å‚¨ `User Message` å’Œ `State Snapshot`ã€‚
    *   **Generation Record (å˜ä½“)**: ä»£è¡¨ AI çš„å¤šç§å›å¤å¯èƒ½æ€§ã€‚å­˜å‚¨ `AI Message`ã€‚
*   **æ¥å£èƒ½åŠ›**:
    *   `addNode(parentId, content)`: åˆ›å»ºæ–°è½®æ¬¡ã€‚
    *   `addRecord(nodeId, content)`: æ·»åŠ  AI å›å¤ã€‚
    *   `getLinearHistory(pointer)`: **å…³é”®æŠ•å½±**ã€‚ä»å½“å‰æŒ‡é’ˆå›æº¯è‡³æ ¹èŠ‚ç‚¹ï¼Œç”Ÿæˆçº¿æ€§å¯¹è¯åˆ—è¡¨ä¾› LLM ä½¿ç”¨ã€‚

### 3.3 æ•°æ®å±‚ï¼šä¸–ç•Œå¼•æ“ (Mnemosyne)
åŸºäº `doc/plan.md` çš„æ¨¡å—åŒ–æ‹†åˆ†ã€‚

*   **World Rules**: æ°¸ä¹…æ³¨å…¥çš„è§„åˆ™ï¼ˆSystem Promptï¼‰ã€‚
*   **Lore (Static)**: é™æ€ç™¾ç§‘ï¼Œæ”¯æŒå‘é‡æ£€ç´¢å’Œå…³é”®è¯åŒ¹é…ã€‚
*   **RPG State (Dynamic)**: 
    *   å­˜å‚¨ç²¾ç¡®æ•°å€¼ (HP, MP, Affinity)ã€‚
    *   **ç‰ˆæœ¬åŒ–ç­–ç•¥**: æ¯æ¬¡çŠ¶æ€å˜æ›´äº§ç”Ÿ Deltaï¼Œåˆå¹¶å…¥ History Engine çš„ `Context Node` å¿«ç…§ä¸­ï¼Œå®ç°çŠ¶æ€ä¸å‰§æƒ…çš„å¼ºç»‘å®šã€‚

---

## 4. å…³é”®äº¤äº’æµç¨‹ (Key Workflows)

### 4.1 æ ‡å‡†å¯¹è¯å¾ªç¯ (The Standard Loop)

æ­¤æµç¨‹å±•ç¤ºäº† Orchestrator å¦‚ä½•åè°ƒ History Engine å’Œ Agentsã€‚

```mermaid
sequenceDiagram
    participant U as User/UI
    participant O as Orchestrator
    participant H as History Engine
    participant P as Planner
    participant G as Core LLM
    participant PP as Post-Process

    Note over U, O: é˜¶æ®µ 1: è¾“å…¥ä¸é”šå®š
    U->>O: å‘é€æ¶ˆæ¯ "æ”»å‡»å“¥å¸ƒæ—"
    O->>H: createNode(parent=Current, content="æ”»å‡»")
    H-->>O: è¿”å› NewNodeID
    O->>O: æ›´æ–°æŒ‡é’ˆ -> NewNodeID

    Note over O, P: é˜¶æ®µ 2: è§„åˆ’ä¸è£…é…
    O->>H: getLinearHistory(NewNodeID)
    H-->>O: è¿”å› [Msg1, Msg2, ..., "æ”»å‡»"]
    O->>P: è¯·æ±‚å†³ç­– (Need Lore? Need State?)
    P-->>O: å†³ç­–ä¿¡å·
    O->>O: æ„å»º PromptAST (æ³¨å…¥ Lore/State)

    Note over O, G: é˜¶æ®µ 3: ç”Ÿæˆ
    O->>G: å‘é€æœ€ç»ˆ Prompt
    G-->>O: æµå¼è¿”å› "ä½ æŒ¥å‰‘å‡»ä¸­äº†..."
    O->>U: å®æ—¶æ›´æ–° UI
    O->>H: createRecord(node=NewNodeID, content=...)

    Note over O, PP: é˜¶æ®µ 4: ç»“ç®—ä¸æŒä¹…åŒ–
    O->>PP: åˆ†æå›å¤å†…å®¹
    PP-->>O: æå–çŠ¶æ€å˜æ›´ {HP: -10}
    O->>H: updateNodeSnapshot(NewNodeID, {HP: 90})
    O->>U: åˆ·æ–°çŠ¶æ€æ 
```

### 4.2 åˆ†æ”¯ä¸å›æº¯ (Branching & Time Travel)

å½“ç”¨æˆ·æƒ³è¦ä¿®æ”¹å†å²æˆ– Reroll æ—¶ï¼š

1.  **Reroll**: 
    *   ä¸åˆ›å»ºæ–° Nodeã€‚
    *   è°ƒç”¨ LLM ç”Ÿæˆæ–°çš„ `Generation Record`ã€‚
    *   å°† Node çš„ `selected_record_id` æŒ‡å‘æ–° Recordã€‚
    *   **ä¼˜åŠ¿**: æ ‘æ·±åº¦ä¸å˜ï¼Œä»…å¢åŠ å½“å‰èŠ‚ç‚¹çš„å®½åº¦ã€‚

2.  **Edit/Branch**:
    *   ç”¨æˆ·åœ¨å†å²èŠ‚ç‚¹ A å¤„ä¿®æ”¹è¾“å…¥ã€‚
    *   ç³»ç»Ÿåˆ›å»ºæ–°èŠ‚ç‚¹ A' (A çš„å…„å¼ŸèŠ‚ç‚¹)ã€‚
    *   æŒ‡é’ˆæŒ‡å‘ A'ã€‚
    *   åç»­ç”ŸæˆåŸºäº A' ç»§ç»­ï¼Œå½¢æˆæ–°çš„ä¸–ç•Œçº¿ã€‚
    *   **çŠ¶æ€å›æ»š**: ç”±äº A' çš„çˆ¶èŠ‚ç‚¹ä¸ A ç›¸åŒï¼Œå®ƒä»¬å…±äº«ä¹‹å‰çš„çŠ¶æ€ï¼›A' è‡ªèº«çš„çŠ¶æ€å¿«ç…§å°†åŸºäºæ–°å‰§æƒ…é‡æ–°è®¡ç®—ã€‚

---

## 5. æ•°æ®æ¶æ„ä¸æŒä¹…åŒ– (Data Architecture)

### 5.1 å®ä½“å…³ç³»å›¾ (ER Diagram)

```mermaid
erDiagram
    ContextNode ||--o{ GenerationRecord : "has_variants"
    ContextNode ||--o{ ContextNode : "parent_child"
    
    ContextNode {
        UUID id PK
        UUID parent_id FK
        TEXT user_content
        JSON state_snapshot "å…³é”®ï¼šæ­¤æ—¶åˆ»çš„ä¸–ç•ŒçŠ¶æ€"
        UUID selected_record_id "å½“å‰é€‰ä¸­çš„å›å¤"
        DATETIME created_at
    }

    GenerationRecord {
        UUID id PK
        UUID node_id FK
        TEXT content
        TEXT reasoning
        JSON metadata
    }

    SessionPointer {
        INT id PK
        UUID current_node_id
        UUID current_record_id
    }

    LoreEntry {
        UUID id PK
        TEXT keys
        TEXT content
        VECTOR embedding
    }
```

### 5.2 æŒä¹…åŒ–ç­–ç•¥
*   **SQLite (Drift)**: å­˜å‚¨ `ContextNode`, `GenerationRecord`, `SessionPointer`, `RPG Variables`ã€‚ä¿è¯äº‹åŠ¡ä¸€è‡´æ€§å’Œç»“æ„åŒ–æŸ¥è¯¢æ•ˆç‡ã€‚
*   **Vector DB**: å­˜å‚¨ `LoreEntry` å’Œ `Memory Summary` çš„ Embeddingsã€‚ç”¨äºè¯­ä¹‰å¬å›ã€‚
*   **Lazy Loading**: UI ä»…åŠ è½½å½“å‰æŒ‡é’ˆè·¯å¾„ä¸Šçš„èŠ‚ç‚¹ï¼ˆLinear Projectionï¼‰ï¼Œéå½“å‰åˆ†æ”¯çš„èŠ‚ç‚¹ä»…åœ¨â€œæŸ¥çœ‹å†å²æ ‘â€æ¨¡å¼ä¸‹æŒ‰éœ€åŠ è½½ã€‚

---

## 6. éåŠŸèƒ½æ€§è®¾è®¡ (Non-Functional Requirements)

### 6.1 æ€§èƒ½ (Performance)
*   **Flutter æ¸²æŸ“**: èŠå¤©åˆ—è¡¨ä»…æ¸²æŸ“ `List<Message>`ï¼Œä¸ç›´æ¥ç»‘å®šæ ‘ç»“æ„ï¼Œé¿å…å¤æ‚ DOM æ“ä½œã€‚
*   **Prompt è®¡ç®—**: æ‰€æœ‰çš„æ­£åˆ™å¤„ç†ã€Token è£å‰ªå‡åœ¨ Dart Isolate (åå°çº¿ç¨‹) ä¸­æ‰§è¡Œï¼Œä¸é˜»å¡ UI çº¿ç¨‹ã€‚

### 6.2 æ‰©å±•æ€§ (Extensibility)
*   **Agent æ’ä»¶åŒ–**: `Planner` å’Œ `Post-Process` å‡è®¾è®¡ä¸ºæ¥å£ã€‚å¯ä»¥è½»æ¾æ›¿æ¢ä¸ºä¸åŒçš„æ¨¡å‹ï¼ˆå¦‚ç”¨ Claude åšè§„åˆ’ï¼Œç”¨ GPT-4 åšç”Ÿæˆï¼‰æˆ–æœ¬åœ°å°æ¨¡å‹ã€‚
*   **Webview æ¡¥æ¥**: åŠ¨æ€ç»„ä»¶ï¼ˆå¦‚çŠ¶æ€æ ï¼‰é€šè¿‡æ ‡å‡†æ¶ˆæ¯åè®®ä¸ Dart é€šä¿¡ï¼ŒUI æ ·å¼å®Œå…¨è§£è€¦ã€‚

### 6.3 å®‰å…¨æ€§ (Security)
*   **API Key ç®¡ç†**: å­˜å‚¨åœ¨åŠ å¯†çš„å®‰å…¨å­˜å‚¨åŒº (Flutter Secure Storage)ã€‚
*   **æ²™ç®±æ‰§è¡Œ**: å¦‚æœæ”¯æŒ JS æ’ä»¶ï¼Œå¿…é¡»åœ¨å—é™çš„ Webview æˆ– JS å¼•æ“ä¸­è¿è¡Œï¼Œç¦æ­¢ç›´æ¥è®¿é—®æ–‡ä»¶ç³»ç»Ÿã€‚
"""
