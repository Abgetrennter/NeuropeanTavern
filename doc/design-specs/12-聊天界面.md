# 12-聊天界面规范

## 文档信息
- **版本**: 1.0.0
- **最后更新**: 2025-12-21
- **依赖**: 所有基础规范文档

---

## 概述

本文档定义SillyTavern核心聊天界面的完整设计规范，包括消息气泡、输入区域、Swipe交互、角色头像、时间戳等所有聊天相关组件。这是整个应用最核心的交互界面。

---

## 1. 消息气泡 (Message Bubble)

### 1.1 基础结构

**HTML结构**:
```html
<div class="mes" data-mes-id="123" is_user="true">
  <div class="avatar">
    <img src="avatar.png" alt="角色名">
  </div>
  <div class="mes_block">
    <div class="ch_name">
      <span class="name_text">角色名</span>
      <span class="timestamp">14:32</span>
    </div>
    <div class="mes_text">消息内容</div>
    <div class="mes_buttons">
      <!-- 操作按钮 -->
    </div>
  </div>
  <div class="swipe_left swipe_control">
    <i class="fa-solid fa-chevron-left"></i>
  </div>
  <div class="swipe_right swipe_control">
    <i class="fa-solid fa-chevron-right"></i>
  </div>
</div>
```

### 1.2 用户消息样式

**CSS定义**:
```css
.mes[is_user="true"] {
  display: flex;
  gap: var(--spacing-sm);
  padding: var(--spacing-md);
  background-color: transparent;
  position: relative;
}

.mes[is_user="true"] .mes_block {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.mes[is_user="true"] .mes_text {
  background-color: var(--user-mes-blur-tint-color, rgba(0, 120, 255, 0.15));
  backdrop-filter: blur(var(--blurStrength));
  border-radius: 12px;
  padding: var(--spacing-sm) var(--spacing-md);
  color: var(--SmartThemeBodyColor);
  font-size: var(--mainFontSize);
  line-height: var(--line-height-base);
  word-wrap: break-word;
  border: 1px solid var(--SmartThemeBorderColor);
}
```

### 1.3 AI消息样式

**CSS定义**:
```css
.mes[is_user="false"] {
  display: flex;
  gap: var(--spacing-sm);
  padding: var(--spacing-md);
  background-color: transparent;
  position: relative;
}

.mes[is_user="false"] .mes_text {
  background-color: var(--bot-mes-blur-tint-color, rgba(100, 100, 100, 0.15));
  backdrop-filter: blur(var(--blurStrength));
  border-radius: 12px;
  padding: var(--spacing-sm) var(--spacing-md);
  color: var(--SmartThemeBodyColor);
  font-size: var(--mainFontSize);
  line-height: var(--line-height-base);
  word-wrap: break-word;
  border: 1px solid var(--SmartThemeBorderColor);
}
```

### 1.4 消息状态

**状态定义**:
| 状态 | 视觉特征 | 应用场景 |
|-----|---------|---------|
| Default | 正常显示 | 已发送的消息 |
| Sending | 半透明 + 加载动画 | 正在发送中 |
| Error | 红色边框 + 错误图标 | 发送失败 |
| Editing | 黄色边框 + 编辑图标 | 编辑模式 |
| Highlighted | 高亮背景 | 搜索结果/引用 |
| Deleted | 删除线 + 低透明度 | 已删除消息 |

**CSS实现**:
```css
/* Sending 状态 */
.mes.sending .mes_text {
  opacity: 0.6;
  position: relative;
}

.mes.sending .mes_text::after {
  content: "";
  position: absolute;
  right: 10px;
  top: 50%;
  width: 16px;
  height: 16px;
  border: 2px solid var(--SmartThemeQuoteColor);
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

/* Error 状态 */
.mes.error .mes_text {
  border-color: var(--error-color);
  background-color: rgba(244, 67, 54, 0.1);
}

/* Editing 状态 */
.mes.editing .mes_text {
  border-color: var(--SmartThemeQuoteColor);
  box-shadow: 0 0 0 2px var(--SmartThemeQuoteColor);
}

/* Highlighted 状态 */
.mes.highlighted {
  background-color: rgba(225, 138, 36, 0.1);
  animation: highlight-pulse 1s ease;
}

@keyframes highlight-pulse {
  0%, 100% { background-color: rgba(225, 138, 36, 0.1); }
  50% { background-color: rgba(225, 138, 36, 0.25); }
}
```

---

## 2. 头像系统

### 2.1 头像容器

**CSS定义**:
```css
.avatar {
  width: 60px;
  height: 60px;
  flex-shrink: 0;
  position: relative;
}

.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
  border: 2px solid var(--SmartThemeBorderColor);
  background-color: var(--black50a);
}

/* Hover 效果 */
.avatar:hover img {
  border-color: var(--SmartThemeQuoteColor);
  transform: scale(1.05);
  transition: all var(--animation-duration) ease;
}
```

### 2.2 在线状态指示器

**CSS定义**:
```css
.avatar::after {
  content: "";
  position: absolute;
  bottom: 2px;
  right: 2px;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background-color: var(--success-color);
  border: 2px solid var(--SmartThemeBodyColor);
}

/* 离线状态 */
.avatar.offline::after {
  background-color: var(--SmartThemeEmColor);
}

/* 忙碌状态 */
.avatar.busy::after {
  background-color: var(--warning-color);
}
```

### 2.3 头像尺寸变体

```css
/* 小尺寸（侧边栏） */
.avatar-sm {
  width: 40px;
  height: 40px;
}

/* 中尺寸（默认） */
.avatar-md {
  width: 60px;
  height: 60px;
}

/* 大尺寸（详情页） */
.avatar-lg {
  width: 100px;
  height: 100px;
}
```

---

## 3. Swipe 交互控制

### 3.1 Swipe 按钮

**CSS定义**:
```css
.swipe_control {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 32px;
  height: 32px;
  background-color: var(--black50a);
  backdrop-filter: blur(var(--blurStrength));
  border: 1px solid var(--SmartThemeBorderColor);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  opacity: 0;
  transition: all var(--animation-duration) ease;
  z-index: 2;
}

.swipe_left {
  left: -16px;
}

.swipe_right {
  right: -16px;
}

/* 消息悬停时显示 */
.mes:hover .swipe_control {
  opacity: 1;
}

/* Hover 状态 */
.swipe_control:hover {
  background-color: var(--SmartThemeQuoteColor);
  border-color: var(--SmartThemeQuoteColor);
  transform: translateY(-50%) scale(1.1);
}

.swipe_control:hover i {
  color: var(--white100);
}

/* Active 状态 */
.swipe_control:active {
  transform: translateY(-50%) scale(0.95);
}
```

### 3.2 Swipe 计数器

**CSS定义**:
```css
.swipe_counter {
  position: absolute;
  bottom: 8px;
  right: 8px;
  background-color: var(--black70a);
  backdrop-filter: blur(var(--blurStrength));
  padding: 4px 8px;
  border-radius: 12px;
  font-size: var(--fontSize-xs);
  color: var(--SmartThemeEmColor);
  border: 1px solid var(--SmartThemeBorderColor);
}

.swipe_counter .current {
  color: var(--SmartThemeQuoteColor);
  font-weight: 600;
}
```

### 3.3 Swipe 动画

```css
/* Swipe 切换动画 */
.mes_text.swipe-enter {
  animation: swipe-in 0.3s ease;
}

@keyframes swipe-in {
  0% {
    opacity: 0;
    transform: translateX(20px);
  }
  100% {
    opacity: 1;
    transform: translateX(0);
  }
}

.mes_text.swipe-exit {
  animation: swipe-out 0.3s ease;
}

@keyframes swipe-out {
  0% {
    opacity: 1;
    transform: translateX(0);
  }
  100% {
    opacity: 0;
    transform: translateX(-20px);
  }
}
```

---

## 4. 消息操作按钮

### 4.1 按钮组布局

**CSS定义**:
```css
.mes_buttons {
  display: flex;
  gap: var(--spacing-xs);
  margin-top: var(--spacing-xs);
  opacity: 0;
  transition: opacity var(--animation-duration) ease;
}

.mes:hover .mes_buttons {
  opacity: 1;
}

.mes_button {
  width: 28px;
  height: 28px;
  background-color: var(--black30a);
  backdrop-filter: blur(var(--blurStrength));
  border: 1px solid var(--SmartThemeBorderColor);
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all var(--animation-duration) ease;
}

.mes_button:hover {
  background-color: var(--SmartThemeQuoteColor);
  border-color: var(--SmartThemeQuoteColor);
  transform: scale(1.1);
}

.mes_button i {
  font-size: var(--fontSize-sm);
  color: var(--SmartThemeBodyColor);
}

.mes_button:hover i {
  color: var(--white100);
}
```

### 4.2 常用按钮

| 按钮 | 图标 | 功能 | 颜色 |
|-----|------|------|------|
| 编辑 | fa-edit | 编辑消息 | 默认 |
| 复制 | fa-copy | 复制内容 | 默认 |
| 删除 | fa-trash | 删除消息 | 错误色 |
| 重新生成 | fa-refresh | 重新生成回复 | 强调色 |
| 标记 | fa-bookmark | 收藏消息 | 默认 |
| 引用 | fa-quote-left | 引用消息 | 默认 |

---

## 5. 输入区域

### 5.1 输入容器

**CSS定义**:
```css
#send_textarea {
  width: 100%;
  min-height: 50px;
  max-height: 200px;
  background-color: var(--black30a);
  backdrop-filter: blur(var(--blurStrength));
  border: 1px solid var(--SmartThemeBorderColor);
  border-radius: 12px;
  padding: var(--spacing-sm) var(--spacing-md);
  color: var(--SmartThemeBodyColor);
  font-family: var(--mainFontFamily);
  font-size: var(--mainFontSize);
  line-height: var(--line-height-base);
  resize: none;
  transition: all var(--animation-duration) ease;
}

#send_textarea:focus {
  outline: 2px solid var(--SmartThemeQuoteColor);
  outline-offset: 2px;
  background-color: var(--black40a);
  border-color: var(--SmartThemeQuoteColor);
}

#send_textarea::placeholder {
  color: var(--SmartThemeEmColor);
}
```

### 5.2 输入工具栏

**CSS定义**:
```css
.input-toolbar {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs) var(--spacing-sm);
  background-color: var(--black20a);
  border-top: 1px solid var(--SmartThemeBorderColor);
  border-radius: 0 0 12px 12px;
}

.toolbar-button {
  width: 32px;
  height: 32px;
  background-color: transparent;
  border: none;
  border-radius: 5px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all var(--animation-duration) ease;
}

.toolbar-button:hover {
  background-color: var(--black50a);
}

.toolbar-button i {
  font-size: var(--fontSize-md);
  color: var(--SmartThemeBodyColor);
}
```

### 5.3 发送按钮

**CSS定义**:
```css
#send_but {
  width: 48px;
  height: 48px;
  background-color: var(--SmartThemeQuoteColor);
  border: none;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all var(--animation-duration) ease;
  box-shadow: 0 2px 8px rgba(225, 138, 36, 0.3);
}

#send_but:hover {
  background-color: var(--SmartThemeQuoteColor);
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(225, 138, 36, 0.5);
}

#send_but:active {
  transform: scale(0.95);
}

#send_but i {
  font-size: var(--fontSize-lg);
  color: var(--white100);
}

/* Disabled 状态 */
#send_but:disabled {
  background-color: var(--black50a);
  cursor: not-allowed;
  opacity: 0.5;
  box-shadow: none;
}
```

---

## 6. 打字指示器

### 6.1 基础样式

**CSS定义**:
```css
.typing_indicator {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: var(--spacing-sm) var(--spacing-md);
  background-color: var(--black30a);
  backdrop-filter: blur(var(--blurStrength));
  border-radius: 20px;
  border: 1px solid var(--SmartThemeBorderColor);
}

.typing_dot {
  width: 8px;
  height: 8px;
  background-color: var(--SmartThemeEmColor);
  border-radius: 50%;
  animation: typing-bounce 1.4s infinite ease-in-out;
}

.typing_dot:nth-child(1) {
  animation-delay: 0s;
}

.typing_dot:nth-child(2) {
  animation-delay: 0.2s;
}

.typing_dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing-bounce {
  0%, 60%, 100% {
    transform: translateY(0);
    background-color: var(--SmartThemeEmColor);
  }
  30% {
    transform: translateY(-10px);
    background-color: var(--SmartThemeQuoteColor);
  }
}
```

---

## 7. 消息分组

### 7.1 日期分隔符

**CSS定义**:
```css
.date-separator {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  margin: var(--spacing-lg) 0;
}

.date-separator::before,
.date-separator::after {
  content: "";
  flex: 1;
  height: 1px;
  background: linear-gradient(
    to right,
    transparent,
    var(--SmartThemeBorderColor),
    transparent
  );
}

.date-separator-text {
  font-size: var(--fontSize-xs);
  color: var(--SmartThemeEmColor);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 4px 12px;
  background-color: var(--black30a);
  border-radius: 12px;
  border: 1px solid var(--SmartThemeBorderColor);
}
```

### 7.2 消息合并

```css
/* 连续相同发送者的消息 */
.mes + .mes[data-sender="same"] {
  margin-top: var(--spacing-xs);
  padding-top: var(--spacing-xs);
}

.mes + .mes[data-sender="same"] .avatar {
  opacity: 0.3;
}

.mes + .mes[data-sender="same"] .ch_name {
  display: none;
}
```

---

## 8. 消息附件

### 8.1 图片附件

**CSS定义**:
```css
.mes_img {
  max-width: 400px;
  border-radius: 8px;
  margin-top: var(--spacing-sm);
  cursor: pointer;
  transition: all var(--animation-duration) ease;
  border: 1px solid var(--SmartThemeBorderColor);
}

.mes_img:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}
```

### 8.2 文件附件

**CSS定义**:
```css
.file-attachment {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm);
  background-color: var(--black30a);
  border-radius: 8px;
  border: 1px solid var(--SmartThemeBorderColor);
  margin-top: var(--spacing-sm);
  cursor: pointer;
  transition: all var(--animation-duration) ease;
}

.file-attachment:hover {
  background-color: var(--black40a);
  border-color: var(--SmartThemeQuoteColor);
}

.file-icon {
  width: 40px;
  height: 40px;
  background-color: var(--SmartThemeQuoteColor);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.file-icon i {
  font-size: var(--fontSize-xl);
  color: var(--white100);
}

.file-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.file-name {
  font-size: var(--fontSize-sm);
  color: var(--SmartThemeBodyColor);
  font-weight: 500;
}

.file-size {
  font-size: var(--fontSize-xs);
  color: var(--SmartThemeEmColor);
}
```

---

## 9. 响应式设计

### 9.1 移动端适配

**CSS定义**:
```css
@media screen and (max-width: 1000px) {
  /* 缩小头像 */
  .avatar {
    width: 40px;
    height: 40px;
  }
  
  /* 减小消息内边距 */
  .mes {
    padding: var(--spacing-sm);
  }
  
  .mes_text {
    padding: var(--spacing-xs) var(--spacing-sm);
    font-size: var(--fontSize-sm);
  }
  
  /* 隐藏Swipe按钮，使用手势 */
  .swipe_control {
    display: none;
  }
  
  /* 始终显示操作按钮 */
  .mes_buttons {
    opacity: 1;
  }
  
  /* 调整输入框 */
  #send_textarea {
    font-size: var(--fontSize-md);
  }
}
```

---

## 10. Figma 使用指南

### 10.1 创建消息组件

1. **创建基础消息框架**：
   - 创建Auto Layout容器（水平）
   - 添加头像（60x60圆形）
   - 添加内容区域（垂直Auto Layout）

2. **添加变体**：
   - 属性：`Sender` = User | AI
   - 属性：`State` = Default | Sending | Error | Editing
   - 属性：`HasSwipe` = True | False

3. **配置Auto Layout**：
   - 主容器：水平，间距`12px`
   - 内容区：垂直，间距`8px`
   - 响应式：Fill container

### 10.2 创建Swipe组件

1. **绘制圆形按钮**：32x32px
2. **添加毛玻璃效果**：
   - Fill: `rgba(0,0,0,0.5)`
   - Effects: Background Blur `20px`
3. **创建变体**：Left | Right

### 10.3 导出JSON规范

```json
{
  "messageBubble": {
    "user": {
      "background": "rgba(0, 120, 255, 0.15)",
      "backdropBlur": "20px",
      "borderRadius": "12px",
      "padding": "8px 12px"
    },
    "ai": {
      "background": "rgba(100, 100, 100, 0.15)",
      "backdropBlur": "20px",
      "borderRadius": "12px",
      "padding": "8px 12px"
    }
  },
  "avatar": {
    "size": {
      "small": "40px",
      "medium": "60px",
      "large": "100px"
    },
    "borderWidth": "2px",
    "borderRadius": "50%"
  },
  "swipeButton": {
    "size": "32px",
    "background": "rgba(0, 0, 0, 0.5)",
    "backdropBlur": "20px",
    "borderRadius": "50%"
  }
}
```

---

## 11. Sketch 使用指南

### 11.1 创建Symbol

1. **消息气泡Symbol**：
   - 创建嵌套Symbol：Avatar + Content + Buttons
   - 使用Smart Layout自动调整高度
   - 创建Override：消息内容、发送者

2. **Swipe控制Symbol**：
   - 使用Blur效果
   - 创建Left/Right变体

### 11.2 使用Craft插件

使用Craft插件填充真实消息数据进行原型测试

---

## 12. 交互动画时序

### 12.1 消息发送流程

```
用户输入 → 点击发送 → 输入框清空(即时) → 消息气泡出现(淡入300ms) → 
发送中状态(显示加载动画) → 收到响应 → 显示AI打字指示器 → 
逐字显示回复(流式) → 完成
```

### 12.2 Swipe动画时序

```
点击Swipe按钮 → 当前消息滑出(300ms) → 新消息滑入(300ms) → 
更新计数器(即时)
```

---

## 相关文档

- [01-设计令牌](./01-设计令牌.md) - CSS变量定义
- [04-按钮组件](./04-按钮组件.md) - 操作按钮规范
- [05-表单控件](./05-表单控件.md) - 输入框规范
- [10-动画与过渡](./10-动画与过渡.md) - 动画细节

---

**最后更新**: 2025-12-21 | **版本**: 1.0.0
