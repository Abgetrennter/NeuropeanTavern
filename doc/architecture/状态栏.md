状态栏嵌入设计说明（v1.0）

目的
在 Flutter 客户端内，以最小成本尽可能可靠地展示第三方“酒馆”角色卡中的状态栏类 UI，同时保留受控交互能力（仅用于向输入框生成草稿文本）。系统优先使用原生渲染以保证一致性和性能；对海量、不可控的第三方前端，以 HTML/WebView 兜底，确保兼容性。


---

一、总体设计原则（必须遵守）

1. 原生优先、Web 兜底：可信/受控内容走原生 Renderer（可下发结构化布局，例如 rfw）；不可控或未知来源走 HTML 渲染或 WebView。


2. 消息级附属：状态栏为单条消息的附属渲染结果，生命周期随消息创建/销毁。


3. 单向受控交互：任何来自状态栏的交互只能产生输入草稿（Input Draft），不得自动发送、不得修改对话历史或世界状态、不得触发生成。


4. 允许失败：状态栏必须可丢弃。渲染失败或超出能力时应优雅降级（不阻断消息文本显示）。


5. 不把 HTML 当作系统表示：HTML/JS/CSS 为脏输入，不作为内部 IR；系统的结构化描述（若存在）为系统真值。




---

二、主要职责与组件

1. ChatMessageItem

作用：承载单条消息文本及其附属插槽。

担当：持有消息上下文（世界书、角色状态等），并提供 MessageStatusSlot 的输入数据。


2. MessageStatusSlot（核心）

作用：状态栏的“路由与防火墙”。

职责：

判断是否存在状态栏数据；

决定渲染路径（原生 Renderer / HTML Renderer / WebView）；

管控尺寸（最大高度、裁剪）、生命周期与降级策略；

记录事件和错误（供调试/监控）。


不做：不解析业务语义、不直接执行来自 UI 的行为。


3. 原生状态栏 Renderer（受控下发）

输入：结构化数据或远程下发的布局（例如 rfw 文件或等价二进制/JSON 结构）。

运行要点：

在客户端用预定义的渲染原语（box、row/column、text、bar、icon、spacer、when、animation）渲染；

严格禁止运行任意远程代码；只允许事件上报（event name + payload）；

事件通过 MessageStatusSlot 转发给 InputDraftController（或被忽略），不直接改变世界状态。


优点：一致性高、性能受控、可下发更新（布局/样式参数化）。


4. HTML 状态栏 Renderer（兜底）

技术：flutter_html 为首选，webview_flutter 仅在必要时使用。

运行要点：

限制或禁止 JS（或仅允许极少量受控桥接）；

强制最大高度和裁剪策略；

只处理交互以提取“文本意图”，通过安全接口送到 InputDraftController；

标注为“兼容 / 降级”UI（记录日志以便未来分析）。


优点：兼容性强，工程投入小。


5. InputDraftController（受控输出通道）

作用：唯一的可写通道，用来接收来自状态栏 UI 的“文本意图”并转换为输入框草稿。

行为契约：

支持操作：append(text)、replace(selection, text)、applyTemplate(template, params)、clearDraft()；

不支持：send、修改对话历史、调用生成接口、改变世界书。

必须允许用户编辑或覆盖草稿；所有变更都可撤销（在消息生命周期内）。


日志：记录来源（rfw/html）、事件 id、payload，以便审计与调试。



---

三、数据流与交互（简洁图示）

世界书 / 对话上下文
        ↓（消息创建）
ChatMessageItem -> MessageStatusSlot
        ↓（选择）
  ┌──────────────┴──────────────┐
  │                             │
原生 Renderer                 HTML Renderer / WebView
  │                             │
  └───────事件（event/payload）──┘
                ↓
        InputDraftController
                ↓
           输入框草稿（由用户确认发送）


---

四、渲染与样式策略

1. 原生 Renderer：采用客户端预置的渲染原语和 Theme 参数（color tokens、radius、shadow、font token、简单动画参数）。下发结构仅描述“类型、绑定、样式名、动画指令（高层）”，不含实现细节。


2. HTML Renderer：将 HTML/CSS 映射为 widget 树但仅支持有限的 CSS 子集（颜色、font-size、background、border、box-shadow、simple layout）。对 CSS hack（负 margin、百分比 padding 作为比例布局等）视为不可保证行为。


3. 样式分工：结构（IR-like）由原生布局或 HTML 描述；视觉（背景花纹、纹理、渐变）归 Theme 或 HTML 原作者（HTML 渲染）；系统只保证“信息可见性”。


4. 动画：原生动画（平滑数值过渡、呼吸灯、闪烁）由 Renderer 实现并受限于预定义动画曲线与持续时间参数。HTML 动画仅在 flutter_html 可安全复现时启用。




---

五、生命周期与资源管理

1. 创建：MessageStatusSlot 在消息创建时加载相关 data；优先检查本地/缓存插件 manifest（plugins_manifest.json）以决定是否下载 rfw 布局。


2. 销毁：随消息销毁释放占用资源；若为 WebView，应销毁并清理 JS channels。


3. 缓存：RFW 布局与资源采用本地缓存（使用 path_provider + dio），同时维护版本号和 ETag。


4. 最大内存约束：对 WebView 与大图片设严控（例如总内存占比与并发 WebView 数上限为 1）。




---

六、错误与降级策略（必须实现）

1. 渲染失败（解析错误、下载失败）→ 不显示状态栏 / 显示占位文本（“状态栏加载失败”）。


2. 高度计算不准或溢出→ 采用最大高度裁剪（scrollable=false，显示“展开查看”按钮将整个网页打开到独立页面）。


3. 交互事件无效→ 记录并忽略，避免影响输入框与消息流。


4. 安全检查失败（检测到可疑 JS 或权限请求）→ 直接切换到 WebView 沙箱或丢弃。


5. 日志与告警：关键失败写入本地日志并上报（可选），记录来源 id、time、error code。




---

七、安全与权限边界

1. 禁止远程执行任意代码：原生 Renderer 不下载并执行 Dart 代码；HTML 渲染限制 JS。


2. 限制外部 API 访问：状态栏事件不得调用网络、本地存储或系统 API；所有系统行为由 App 的“标准能力库”通过受控事件触发（需用户确认）。


3. 数据隔离：状态栏不得直接读取或写入敏感本地数据（token、账户信息）。


4. 审计日志：事件来源、payload、受控输出应可审计，便于安全分析。




---

八、工程选型（建议）

Flutter 原生：Provider 或 Bloc（状态管理）；path_provider + dio（下载/缓存）；shared_preferences（小配置缓存）。

原生下发布局：采用 rfw（Remote Flutter Widgets）或自定义轻量 JSON 布局格式（字段受限、无脚本）。

HTML 渲染：flutter_html 为首选；必要时 webview_flutter（仅用于复杂不可解析页面并采用沙箱）。

日志/监控：本地日志 + 可选上报（错误/降级统计）。



---

九、最小实现清单（按优先级）

1. 在 ChatMessageItem 中添加 MessageStatusSlot（渲染占位与大小控制）。


2. 实现 MessageStatusSlot 的分流逻辑（优先检查本地 plugin manifest，再 fallback HTML）。


3. 集成 flutter_html 并实现最大高度 & 裁剪逻辑，以及交互到 InputDraftController 的桥接。


4. 实现 InputDraftController（append/replace/template），接入输入框草稿显示与用户可编辑功能。


5. 集成简单 rfw 加载器（或本地 JSON layout），实现一个最基本的原生 Renderer（支持 bar/text/row/column/spacer/when）。


6. 实现下载与缓存（dio + path_provider）与插件 manifest 管理。


7. 日志记录与错误降级提示（本地显示“加载失败”）。




---

十、扩展与未来方向（非必要、按需）

1. 统计与发现常见 HTML 模板，逐步把高频模板做成 rfw 插件下发替换。


2. 在明确需求后再考虑引入更复杂的 IR 与 Theme 系统（仅当用户量与维护资源提升时）。


3. 可选：对少量可信作者开放“rfw 提交机制”，形成插件市场。




---

十一、验收标准（可量化）

功能：MessageStatusSlot 正常在 >95% 的消息创建/销毁场景不阻塞主消息渲染。

兼容性：对常见状态栏 HTML，flutter_html 能在 80% 场景下展示合理内容（不保证像素级一致）。

安全：无远程代码执行风险；所有来自状态栏的输出只进入输入草稿；无自动发送行为。

降级：任一失败场景下，用户能看到“占位/错误信息”，消息文本不受影响。



---

附：关键接口定义（伪接口）

MessageStatusSlot API（概念）

init(messageContext)：初始化，触发路径选择。

render()：根据选择调用 renderer。

onEvent(event)：接收 renderer 的交互事件，统一转到 InputDraftController。

destroy()：清理资源。


InputDraftController API

appendText(sourceId, text)

replaceRange(sourceId, start, end, text)

applyTemplate(sourceId, templateId, params)

clearDraft(sourceId)

getDraft() → 当前草稿字符串


